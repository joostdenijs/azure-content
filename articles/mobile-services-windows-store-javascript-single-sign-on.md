<properties 
	pageTitle="Authenticate your app with Live Connect (JavaScript)" 
	description="Learn how to use Live Connect single sign-on in Azure Mobile Services from a Windows Store application." 
	services="mobile-services" 
	documentationCenter="windows" 
	authors="ggailey777" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="mobile-services" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="mobile-windows-store" 
	ms.devlang="javascript" 
	ms.topic="article" 
	ms.date="04/08/2015" 
	ms.author="glenga"/>

# Authenticate your Windows Store app with client managed authentication using Microsoft account

[AZURE.INCLUDE [mobile-services-selector-single-signon](../includes/mobile-services-selector-single-signon.md)]	

##Overview
This topic shows you how to authenticate users in Azure Mobile Services from a Windows Store app.  In this tutorial, you add authentication to the quickstart project using Live Connect. When successfully authenticated by Live Connect, a logged-in user is welcomed by name and the user ID value is displayed.  

>[AZURE.NOTE]This tutorial demonstrates the benefits of using client-managed authentication and the Live SDK. This enables you to more easily authenticate an already logged-on user with you mobile service. You can also request additional scopes to enable your app to also access resources like OneDrive. 
>Service-managed authentication provides a more generalized experience and supports multiple authentication providers. For more information about service-managed authentication, see the topic [Add authentication to your app](mobile-services-windows-store-javascript-get-started-users.md).

This tutorial requires the following:

+ [Live SDK for Windows]
+ Microsoft Visual Studio 2012 Express for Windows 8 RC, or a later version
+ You must also first complete the tutorial [Add Mobile Services to an existing app].

##Register your app to use Microsoft account for authentication

To be able to authenticate users, you must register your app at the Microsoft account Developer Center. You must then connect this registration with your mobile service. Please complete the steps in the following topic to create a Microsoft account registration and connect it to your mobile service.

+ [Register your app to use a Microsoft account login](mobile-services-how-to-register-microsoft-authentication.md)

##<a name="permissions"></a>Restrict permissions to authenticated users

You next need to restrict access to a resource, in this case the *TodoItems* table to make sure it can only be accessed by a signed-in user.

[AZURE.INCLUDE [mobile-services-restrict-permissions-windows](../includes/mobile-services-restrict-permissions-windows.md)]  

##<a name="add-authentication"></a>Add authentication to the app

Finally, you add the Live SDK and use it to authenticate users in your app.

1. In **Solution Explorer**, right-click the solution, and then select **Manage NuGet Packages**.

2. In the left pane, select the **Online** category, search for **LiveSDK**, click **Install** on the **Live SDK** package, select all projects, then accept the license agreements. 

  	This adds the Live SDK to the solution.

3. Open the default.html project file and add the following `<script>` element in the `<head>` element. 

        <script src="/js/wl.js"></script>

5. In the **app.OnActivated** method overload, replace the call to the **refreshTodoItems** method  with the following code: 
	
        // Set the mobileClient variable to client variable generated by the tooling.
        var mobileClient = <yourClient>;

        var session = null;
        var login = function () {
            return new WinJS.Promise(function (complete) {
                WL.login({ scope: "wl.basic" }).then(function (result) {
                    session = result.session;

                    WinJS.Promise.join([
                        WL.api({ path: "me", method: "GET" }),
                        mobileClient.login(result.session.authentication_token)
                    ]).done(function (results) {
                        // Build the welcome message from the Microsoft account info.
                        var profile = results[0];                            
                        var title = "Welcome " + profile.first_name + "!";
                        var message = "You are now logged in as: "
                            + mobileClient.currentUser.userId;
                        var dialog = new Windows.UI.Popups.MessageDialog(message, title);
                        dialog.showAsync().then(function () {
                            // Reload items from the mobile service.
                            refreshTodoItems();
                        }).done(complete);
                        
                    }, function (error) {

                    });
                }, function (error) {
                    session = null;
                    var dialog = new Windows.UI.Popups.MessageDialog("You must log in.", "Login Required");
                    dialog.showAsync().done(complete);
                });
            });
        }

        var authenticate = function () {
            // Block until sign-in is successful.
            login().then(function () {
                if (session === null) {
                    // Authentication failed, try again.
                    authenticate();
                }
            });
        }

		// Initialize the Live client.
        WL.init({
            redirect_uri: mobileClient.applicationUrl
        });

		// Start the sign-in process.
        authenticate();

    This initializes the Live Connect client, sends a new login request to Microsoft account, sends the returned authentication token to Mobile Services, and then displays information about the signed-in user. 

	>[AZURE.NOTE]Ideally, you should not request either Live Connection authentiction tokens or Mobile Services authorization tokens every time that your app runs. Not only is this inefficient, you can run into usage-relates issues should many customers try to start your app at the same time. A better approach is to cache the tokens and first try to use the cached Mobile Services token before calling **LoginWithMicrosoftAccountAsync**. For an example of how to cache this token, see [Get started with authentication](mobile-services-windows-store-javascript-get-started-users.md#tokens)
	
7. Replace the value `<yourClient>` in the first line of above code with the variable defined in the .js file added when you connected your project to the mobile service.
		
8. Press the F5 key to run the app and sign in with your Microsoft account. 

   	When you are successfully signed-in, the app should run without errors, and you should be able to query Mobile Services and make updates to data.

## <a name="next-steps"> </a>Next steps

In the next tutorial, [Authorize users with scripts], you will take the user ID value provided by Mobile Services based on an authenticated user and use it to filter the data returned by Mobile Services. For information about how to use other identity providers for authentication, see [Get started with authentication].

<!-- Anchors. -->
[Register your app for authentication and configure Mobile Services]: #register
[Restrict table permissions to authenticated users]: #permissions
[Add authentication to the app]: #add-authentication
[Next Steps]:#next-steps

<!-- Images. -->

<!-- URLs. -->
[Submit an app page]: http://go.microsoft.com/fwlink/p/?LinkID=266582
[My Applications]: http://go.microsoft.com/fwlink/p/?LinkId=262039
[Live SDK for Windows]: http://go.microsoft.com/fwlink/p/?LinkId=262253
[Add Mobile Services to an existing app]: mobile-services-windows-store-javascript-get-started-data.md
[Get started with authentication]: mobile-services-windows-store-javascript-get-started-users.md
[Authorize users with scripts]: mobile-services-windows-store-javascript-authorize-users-in-scripts.md

[Azure Management Portal]: https://manage.windowsazure.com/
